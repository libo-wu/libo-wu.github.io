---
title: 'STM32 RTC functions'
date: 2019-12-09
permalink: /posts/2019/2019-12-09-blog-post/
tags:
  - STM32 Study Note
  - CubeIDE
  - RTC
  - Interrupt
---
Introduction
==
This post intends to explore the functions of the Real Time Clock (RTC) of STM32 microcontrollers. This time we also use CubeMX, the powerful code generator for STM32 MCUs.

The purpose for this post is to get familiar with the RTC for uCs and intend to use this for my next step of the research project. 

My next work is to design a sensor node that could wakeup every minute (or other time period), and do the following functions:

1. generate PWM waveforms to drive the LC shutter for a specific time (maybe 10-15 seconds).
2. read data from the PIR sensor and temperature sensor
3. send the data to the server (via Bluetooth, Wifi, ZigBee, etc)
4. enter sleep mode.

Also, during the sleep mode, the MCU should be able to woken up by the motion of the person. This is done by attach an external pin from PIR sensor to the MCU. 

Concerns
--
Right now the PIR sensors which is integrated with LC shutter is the AMN24112 analog PIR sensor, which require ADC to poll the signals. ADC consumes high power. If we really stick to this sensor model, it is difficult to wake up the MCU since the MCU is sensitive to the edge of the attached pin, but the analog signals from the PIR sensor is not analog.

Solutions:

1. USe a second digital PIR sensor and attach the output pin to the wakeup pin.
2. Add an comparator that could generate edge once the signal from the analog sensor reached certain level.

Alarm
==
Goal
--
Use an LCD-SSD1306, to show the calendar in real time, then add an "alarm" sign when the second reach 0 every minute. The "alarm" sign would disappear after 5 seconds.

Setup
--
After create the new project, setup the RTC and I2C1 as follows. Here we use two alarms, ALARMA and ALARMB. Note that the Alarm masks for date, hour, minute are enabled, to ignore the number in these fields.

![Pin setup](http://libowu.com/images/post_img/12-09-post-rtc-setup2.PNG)

![RTC setup](http://libowu.com/images/post_img/12-09-post-rtc-setup1.PNG)

Demo
--
[![Demo video](http://libowu.com/images/post_img/12-09-post-video-img.PNG)](https://www.youtube.com/watch?v=cbLt2TRxLOE)

From the demo video, we could see that when the board start at 2019/12/31 23:59:45. When the time reached 2020/1/1 00:00:00, the "alarm" sign apears. After 5 seconds, it disappears. Not shown in the video, the "alarm" sign would appear every minute when the second is at 0, and disappear after 5 seconds.

Wakeup
==

